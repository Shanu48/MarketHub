<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Home</title>
  <link rel="stylesheet" href="customer.css" />
</head>

<body>
  <!-- Header Section -->
  <header>
    <nav>
      <a href="customer_home.html">
        <img src="images/logo.png" alt="MarketHub" style="border-radius: 50%; height: 50px;" />
      </a>
      <ul class="nav-links">
        <li>
          <a href="../index.html" style="background-color: rgb(255, 140, 0); border-radius: 5px; padding: 5px 10px; box-shadow: 0 0 5px rgb(0, 133, 62);">Logout</a>
        </li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="cart.html">Cart</a></li>
        <li><a href="order_details.html">Orders</a></li>
        <li><a href="returns.html">Returns</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-overlay">
      <h1>MarketHub</h1>
      <p><b>Buy fresh & organic wholesale groceries</b></p>
      <p>Directly from known suppliers at the best prices!!</p>
      <div class="hero-buttons" style="margin-top: 10px;">
        <a class="shop-btn" href="#product">Shop Now</a>
      </div>
    </div>
  </section>

  <!-- Search and Filter Section -->
  <section class="search_n_filter">
    <input type="text" id="search-bar" placeholder="Search Product" />

    <select id="sort-options">
      <option value="">Sort By</option>
      <option value="price-low">Price: Low to High</option>
      <option value="price-high">Price: High to Low</option>
      <option value="discount">Discount</option>
    </select>

    <!-- Filter Type -->
    <select id="filter-type">
      <option value="">Filter by</option>
      <option value="category">Category</option>
      <option value="supplier">Supplier</option>
    </select>

    <!-- Dynamic Options -->
    <select id="filter-options" style="display: none;"></select>
  </section>

  <!-- Product Container -->
  <section class="product-table">
    <div class="table-header">
        <div class="col" style="display: none;">Product ID</div>
        <div class="col">Product</div>
        <div class="col">Description</div>
        <div class="col">Price</div>
        <div class="col">Category</div>
        <div class="col">Supplier</div>
        <div class="col">Actions</div>
    </div>
    
    <div id="product-rows" class="table-body">
        <!-- Dynamic content will be inserted here -->
    </div>
</section>


<style>
.product-table {
  margin: 2rem;
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.1);
}

.table-header, .product-row {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr;
  gap: 1rem;
  padding: 1rem;
  align-items: center;
}

.table-header {
  background: #f8f9fa;
  font-weight: 600;
  border-bottom: 2px solid #eee;
  border-radius: 10px 10px 0 0;
}

.product-row {
  border-bottom: 1px solid #eee;
  transition: background 0.3s ease;
}

.product-row:hover {
  background: #f8f9fa;
}

.product-image {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  margin-right: 1rem;
}

.add-cart-btn {
  background: #28a745;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.add-cart-btn:hover {
  background: #218838;
}
</style>


  <script>
    
    let allProducts = [];

    function formatImageName(pName) {
      return pName.toLowerCase().replace(/\s+/g, "") + ".png";
    }

    async function fetchProducts() {
      try {
        const response = await fetch("http://127.0.0.1:5000/products");
        allProducts = await response.json();
        displayProducts(allProducts);
        populateFilterOptions(); // Populate filters after loading products
      } catch (error) {
        console.error("Error fetching products:", error);
      }
    }

    function displayProducts(products) {
    const container = document.getElementById("product-rows");
    container.innerHTML = "";

    products.forEach(product => {
        const row = document.createElement("div");
        row.className = "product-row";
        row.setAttribute("data-product-id", product.productID);  // Store productID on row
        
        const imageName = formatImageName(product.pName);
        const imagePath = `images/${imageName}`;

        row.innerHTML = `
            <div class="col" style="display: none;">${product.productID}</div>
            <div class="col">
                <img src="${imagePath}" alt="${product.pName}" class="product-image">
                ${product.pName}
            </div>
            <div class="col">${product.description}</div>
            <div class="col">â‚¹${product.price}/${product.unit}</div>
            <div class="col">${product.categoryName}</div>
            <div class="col">${product.sName}</div>
            <div class="col">
                <button class="add-cart-btn">Add to Cart</button>
            </div>
        `;

        // Add event listener to the button
        const button = row.querySelector('.add-cart-btn');
        button.addEventListener('click', function(event) {
            const productID = event.target.closest('.product-row').dataset.productId;
            addToCart(productID);
        });

        container.appendChild(row);
    });
}



function addToCart(productID) {
  fetch("/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productID })  // Remove userID from here
    })
    .then(res => {
        console.log("Response status:", res.status); // Debug
        return res.json();
    })
    .then(data => {
        console.log("Response data:", data); // Debug
        if (data.success) {
            renderQtyControls(productID, 1);
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Cart Error:', error);
        alert(`Cart update failed: ${error.message}`);
    });
}



    function applyFilters() {
      let filtered = [...allProducts];

      const searchText = document.getElementById("search-bar").value.toLowerCase();
      const sort = document.getElementById("sort-options").value;
      const filterType = document.getElementById("filter-type").value;
      const filterValue = document.getElementById("filter-options").value;

      if (searchText) {
        filtered = filtered.filter(p => p.pName.toLowerCase().includes(searchText));
      }

      if (filterType && filterValue) {
        if (filterType === "category") {
          filtered = filtered.filter(p => p.categoryName === filterValue);
        } else if (filterType === "supplier") {
          filtered = filtered.filter(p => p.sName === filterValue);
        }
      }

      if (sort === "price-low") {
        filtered.sort((a, b) => a.price - b.price);
      } else if (sort === "price-high") {
        filtered.sort((a, b) => b.price - a.price);
      }

      displayProducts(filtered);
    }

    function populateFilterOptions() {
      const filterType = document.getElementById("filter-type").value;
      const filterOptions = document.getElementById("filter-options");

      if (!filterType) {
        filterOptions.style.display = "none";
        return;
      }

      const uniqueValues = new Set();
      allProducts.forEach(p => {
        if (filterType === "category") uniqueValues.add(p.categoryName);
        else if (filterType === "supplier") uniqueValues.add(p.sName);
      });

      filterOptions.innerHTML = `<option value="">Select</option>`;
      uniqueValues.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        filterOptions.appendChild(option);
      });

      filterOptions.style.display = "inline-block";
    }

    function addToCart(productID) {
      const userID = getUserID();
      fetch("http://127.0.0.1:5000/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productID, userID, quantity: 1 })
      })
      .then(res => res.json())
      .then(() => {
        renderQtyControls(productID, 1);
      });
    }
    
    function renderQtyControls(productID, quantity) {
    const container = document.getElementById(`cart-${productID}`);
    container.innerHTML = `
      <div class="quantity-controls">
        <button onclick="updateCart(${productID}, -1)">-</button>
        <span id="qty-${productID}">${quantity}</span>
        <button onclick="updateCart(${productID}, 1)">+</button>
      </div>
    `;
  }


    function updateCart(productID, change) {
      const userID = getUserID();
      const qtySpan = document.getElementById(`qty-${productID}`);
      let quantity = parseInt(qtySpan.innerText) + change;

      if (quantity <= 0) {
        fetch("http://127.0.0.1:5000/cart/remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productID, userID })
        })
        .then(res => res.json())
        .then(() => {
          document.getElementById(`cart-${productID}`).innerHTML = `
            <button class="add-cart-btn" onclick="addToCart(${productID})">Add to Cart</button>
          `;
        });
      } else {
        fetch("http://127.0.0.1:5000/cart/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productID, userID, quantity })
        })
        .then(res => res.json())
        .then(() => {
          qtySpan.innerText = quantity;
        });
      }
    }

    function getUserID() {
      return localStorage.getItem("userID");
    }

    // Event Listeners
    document.getElementById("search-bar").addEventListener("input", applyFilters);
    document.getElementById("sort-options").addEventListener("change", applyFilters);
    document.getElementById("filter-options").addEventListener("change", applyFilters);
    document.getElementById("filter-type").addEventListener("change", () => {
      populateFilterOptions();
      applyFilters();
    });

    fetchProducts();
  </script>
</body>

</html>
