<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Home</title>
  <link rel="stylesheet" href="customer.css" />
</head>

<body>
  <!-- Header Section -->
  <header>
    <nav>
        <a href="supplier_home.html"><img src="images/logo.png" alt="MarketHub"></a>
        <ul class="nav-links">
            <li><a href="profile.html">Profile</a></li>
            <li><a href="cart.html">Cart</a></li>
            <li><a href="order_details.html">Orders</a></li>
            <li><a href="returns.html">Returns</a></li>
            <li><a href="../index.html" class="logout">Logout</a></li>
        </ul>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-overlay">
      <h1>MarketHub</h1>
      <p><b>Buy fresh & organic wholesale groceries</b>
        <br>Directly from known suppliers at the best prices!!
      </p>
      <div class="hero-buttons" style="margin-top: 10px;">
        <a class="shop-btn" href="#search-bar">Shop Now</a>
      </div>
    </div>
  </section>

  <!-- Search and Filter Section -->
  <section class="search_n_filter">
    <input type="text" id="search-bar" placeholder="Search Product" />

    <select id="sort-options">
      <option value="">Sort By</option>
      <option value="price-low">Price: Low to High</option>
      <option value="price-high">Price: High to Low</option>
      <option value="discount">Discount</option>
    </select>

    <!-- Filter Type -->
    <select id="filter-type">
      <option value="">Filter by</option>
      <option value="category">Category</option>
      <option value="supplier">Supplier</option>
    </select>

    <!-- Dynamic Options -->
    <select id="filter-options" style="display: none;"></select>
  </section>

  <!-- Product Container -->
  <section class="product-table">
    <div class="table-header">
        <div class="col" style="display: none;">Product ID</div>
        <div class="col">Product</div>
        <div class="col">Description</div>
        <div class="col">Price</div>
        <div class="col">Category</div>
        <div class="col">Supplier</div>
        <div class="col">Actions</div>
    </div>
    
    <div id="product-rows" class="table-body">
        <!-- Dynamic content will be inserted here -->
    </div>
</section>
  <script>
    
    let allProducts = [];

    function formatImageName(pName) {
      return pName.toLowerCase().replace(/\s+/g, "") + ".png";
    }

    async function fetchProducts() {
      try {
        const response = await fetch("http://127.0.0.1:5000/products");
        allProducts = await response.json();
        displayProducts(allProducts);
        populateFilterOptions(); // Populate filters after loading products
      } catch (error) {
        console.error("Error fetching products:", error);
      }
    }

    function displayProducts(products) {
    const container = document.getElementById("product-rows");
    container.innerHTML = "";

    products.forEach(product => {
        const row = document.createElement("div");
        row.className = "product-row";
        row.setAttribute("data-product-id", product.productID);
        
        const imageName = formatImageName(product.pName);
        const imagePath = `images/${imageName}`;

        row.innerHTML = `
            <div class="col" style="display: none;">${product.productID}</div>
            <div class="col">
                <img src="${imagePath}" alt="${product.pName}" class="product-image">
                ${product.pName}
            </div>
            <div class="col">${product.description}</div>
            <div class="col">â‚¹${product.price}/${product.unit}</div>
            <div class="col">${product.categoryName}</div>
            <div class="col">${product.sName}</div>
            <div class="col">
                <button class="add-cart-btn" data-product-id="${product.productID}" onclick="addToCart('${product.productID}')">Add to Cart</button>
            </div>
        `;

        container.appendChild(row);
    });
}



function addToCart(productID) {
  console.log(`[DEBUG] Attempting to add product ${productID} to cart`);
  
  fetch("http://127.0.0.1:5000/cart/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ productID })
  })
  .then(res => {
    console.log(`[DEBUG] Add to cart response status: ${res.status}`);
    return res.json();
  })
  .then(data => {
    console.log(`[DEBUG] Add to cart response data:`, data);
    if (data.success) {
      // Find all buttons for this product and replace them
      const buttons = document.querySelectorAll(`.add-cart-btn[data-product-id="${productID}"]`);
      console.log(`[DEBUG] Found ${buttons.length} buttons to replace`);
      
      buttons.forEach(button => {
        button.outerHTML = `
          <div class="quantity-controls" data-product-id="${productID}">
            <button class="qty-btn minus" onclick="updateCart('${productID}', -1)">-</button>
            <span class="qty-value">1</span>
            <button class="qty-btn plus" onclick="updateCart('${productID}', 1)">+</button>
          </div>
        `;
      });
    } else {
      console.error(`[ERROR] Failed to add to cart: ${data.error}`);
      alert(data.error || 'Failed to add to cart');
    }
  })
  .catch(error => {
    console.error('[ERROR] Add to cart error:', error);
    alert('Failed to add to cart');
  });
}

function updateCart(productID, change) {
  console.log(`[DEBUG] Updating cart for product ${productID} with change ${change}`);
  
  // Find all quantity controls for this product
  const quantityControls = document.querySelectorAll(`.quantity-controls[data-product-id="${productID}"]`);
  console.log(`[DEBUG] Found ${quantityControls.length} quantity controls`);
  
  if (quantityControls.length === 0) {
    console.error('[ERROR] No quantity controls found for product:', productID);
    return;
  }
  
  const firstControl = quantityControls[0];
  const quantitySpan = firstControl.querySelector('.qty-value');
  let currentQuantity = parseInt(quantitySpan.textContent);
  let newQuantity = currentQuantity + change;
  
  console.log(`[DEBUG] Current quantity: ${currentQuantity}, New quantity: ${newQuantity}`);
  
  if (newQuantity <= 0) {
    console.log(`[DEBUG] Removing product ${productID} from cart`);
    
    fetch("http://127.0.0.1:5000/cart/remove", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ productID })
    })
    .then(res => {
      console.log(`[DEBUG] Remove from cart response status: ${res.status}`);
      return res.json();
    })
    .then(data => {
      console.log(`[DEBUG] Remove from cart response data:`, data);
      if (data.success) {
        // Replace all quantity controls with "Add to Cart" button
        quantityControls.forEach(control => {
          control.outerHTML = `
            <button class="add-cart-btn" data-product-id="${productID}" onclick="addToCart('${productID}')">
              Add to Cart
            </button>
          `;
        });
      } else {
        console.error(`[ERROR] Failed to remove from cart: ${data.error}`);
        alert(data.error || 'Failed to remove from cart');
      }
    })
    .catch(error => {
      console.error('[ERROR] Remove from cart error:', error);
      alert('Failed to remove from cart');
    });
  } else {
    console.log(`[DEBUG] Updating quantity to ${newQuantity}`);
    
    fetch("http://127.0.0.1:5000/cart/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ productID, quantity: newQuantity })
    })
    .then(res => {
      console.log(`[DEBUG] Update cart response status: ${res.status}`);
      return res.json();
    })
    .then(data => {
      console.log(`[DEBUG] Update cart response data:`, data);
      if (data.success) {
        // Update all quantity displays for this product
        quantityControls.forEach(control => {
          control.querySelector('.qty-value').textContent = newQuantity;
        });
      } else {
        console.error(`[ERROR] Failed to update cart: ${data.error}`);
        alert(data.error || 'Failed to update cart');
      }
    })
    .catch(error => {
      console.error('[ERROR] Update cart error:', error);
      alert('Failed to update cart');
    });
  }
}

    function applyFilters() {
      let filtered = [...allProducts];

      const searchText = document.getElementById("search-bar").value.toLowerCase();
      const sort = document.getElementById("sort-options").value;
      const filterType = document.getElementById("filter-type").value;
      const filterValue = document.getElementById("filter-options").value;

      if (searchText) {
        filtered = filtered.filter(p => p.pName.toLowerCase().includes(searchText));
      }

      if (filterType && filterValue) {
        if (filterType === "category") {
          filtered = filtered.filter(p => p.categoryName === filterValue);
        } else if (filterType === "supplier") {
          filtered = filtered.filter(p => p.sName === filterValue);
        }
      }

      if (sort === "price-low") {
        filtered.sort((a, b) => a.price - b.price);
      } else if (sort === "price-high") {
        filtered.sort((a, b) => b.price - a.price);
      }

      displayProducts(filtered);
    }

    function populateFilterOptions() {
      const filterType = document.getElementById("filter-type").value;
      const filterOptions = document.getElementById("filter-options");

      if (!filterType) {
        filterOptions.style.display = "none";
        return;
      }

      const uniqueValues = new Set();
      allProducts.forEach(p => {
        if (filterType === "category") uniqueValues.add(p.categoryName);
        else if (filterType === "supplier") uniqueValues.add(p.sName);
      });

      filterOptions.innerHTML = `<option value="">Select</option>`;
      uniqueValues.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        filterOptions.appendChild(option);
      });

      filterOptions.style.display = "inline-block";
    }

    // Event Listeners
    document.getElementById("search-bar").addEventListener("input", applyFilters);
    document.getElementById("sort-options").addEventListener("change", applyFilters);
    document.getElementById("filter-options").addEventListener("change", applyFilters);
    document.getElementById("filter-type").addEventListener("change", () => {
      populateFilterOptions();
      applyFilters();
    });

    fetchProducts();
  </script>
</body>

</html>
