<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Home</title>
  <link rel="stylesheet" href="customer.css" />
</head>
<body>
  <!-- Header Section -->
  <header>
    <nav>
      <a href="customer_home.html">
        <img src="images/logo.png" alt="MarketHub" style="border-radius: 50%; height: 50px;" />
      </a>
      <ul class="nav-links">
        <li><a href="../index.html" style="background-color: rgb(255, 140, 0); border-radius: 5px; padding: 5px 10px; box-shadow: 0 0 5px rgb(0, 133, 62);">Logout</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="cart.html">Cart</a></li>
        <li><a href="order_details.html">Orders</a></li>
        <li><a href="returns.html">Returns</a></li>
      </ul>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-overlay">
      <h1>MarketHub</h1>
      <p><b>Buy fresh & organic wholesale groceries</b></p>
      <p>Directly from known suppliers at the best prices!!</p>
      <div class="hero-buttons" style="margin-top: 10px;">
        <a class="shop-btn" href="#product">Shop Now</a>
      </div>
    </div>
  </section>

  <!-- Search and Filter Section -->
  <section class="search_n_filter">
    <input type="text" id="search-bar" placeholder="Search Product" />
    
    <select id="sort-options">
      <option value="">Sort By</option>
      <option value="price-low">Price: Low to High</option>
      <option value="price-high">Price: High to Low</option>
      <option value="discount">Discount</option>
    </select>

    <!-- Filter Type -->
    <select id="filter-type">
      <option value="">Filter by</option>
      <option value="category">Category</option>
      <option value="supplier">Supplier</option>
    </select>

    <!-- Dynamic Options -->
    <select id="filter-options" style="display: none;"></select>
  </section>

  <div id="product-container" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>

  <script>
    let allProducts = [];

    function formatImageName(pName) {
      return pName.toLowerCase().replace(/\s+/g, "") + ".png";
    }

    async function fetchProducts() {
      try {
        const response = await fetch("http://127.0.0.1:5000/products");
        allProducts = await response.json();
        displayProducts(allProducts);
        populateFilterOptions(); // Populate filters after loading products
      } catch (error) {
        console.error("Error fetching products:", error);
      }
    }

    function displayProducts(products) {
      const container = document.getElementById("product-container");
      container.innerHTML = "";

      if (!Array.isArray(products) || products.length === 0) {
        container.innerHTML = "<p>No products found</p>";
        return;
      }

      products.forEach(product => {
        const productDiv = document.createElement("div");
        productDiv.classList.add("product-card");

        const imageName = formatImageName(product.pName);
        const imagePath = `images/${imageName}`;

        productDiv.innerHTML = `
          <img src="${imagePath}" alt="${product.pName}" class="product-image"
            style="width: 200px; height: 200px; object-fit: cover; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
          <h3>${product.pName}</h3>
          <p>${product.description}</p>
          <p><strong>Price:</strong> â‚¹${product.price} per ${product.unit}</p>
          <p><strong>Category:</strong> ${product.categoryName}</p>
          <p><strong>Supplier:</strong> ${product.sName}</p>
        `;
        container.appendChild(productDiv);
      });
    }

    function applyFilters() {
      let filtered = [...allProducts];

      const searchText = document.getElementById("search-bar").value.toLowerCase();
      const sort = document.getElementById("sort-options").value;
      const filterType = document.getElementById("filter-type").value;
      const filterValue = document.getElementById("filter-options").value;

      if (searchText) {
        filtered = filtered.filter(p => p.pName.toLowerCase().includes(searchText));
      }

      if (filterType && filterValue) {
        if (filterType === "category") {
          filtered = filtered.filter(p => p.categoryName === filterValue);
        } else if (filterType === "supplier") {
          filtered = filtered.filter(p => p.sName === filterValue);
        }
      }

      if (sort === "price-low") {
        filtered.sort((a, b) => a.price - b.price);
      } else if (sort === "price-high") {
        filtered.sort((a, b) => b.price - a.price);
      }

      displayProducts(filtered);
    }

    function populateFilterOptions() {
      const filterType = document.getElementById("filter-type").value;
      const filterOptions = document.getElementById("filter-options");

      if (!filterType) {
        filterOptions.style.display = "none";
        return;
      }

      const uniqueValues = new Set();
      allProducts.forEach(p => {
        if (filterType === "category") uniqueValues.add(p.categoryName);
        else if (filterType === "supplier") uniqueValues.add(p.sName);
      });

      filterOptions.innerHTML = `<option value="">Select</option>`;
      uniqueValues.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        filterOptions.appendChild(option);
      });

      filterOptions.style.display = "inline-block";
    }

    // Event Listeners
    document.getElementById("search-bar").addEventListener("input", applyFilters);
    document.getElementById("sort-options").addEventListener("change", applyFilters);
    document.getElementById("filter-options").addEventListener("change", applyFilters);

    document.getElementById("filter-type").addEventListener("change", () => {
      populateFilterOptions();
      applyFilters();
    });

    fetchProducts();
  </script>
</body>
</html>
